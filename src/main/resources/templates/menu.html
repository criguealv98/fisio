<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menú Principal</title>
<link href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/cosmo/bootstrap.min.css" rel="stylesheet">
    
</head>
<body>
    <div class="container">
<h1 id="mensaje" class="my-4" th:text="${mensaje}"></h1>

        <!-- Botones de navegación -->
        <button class="btn btn-primary" id="btnVerCitas" style="display:none;" onclick="verCitas()">Ver Citas</button>
        <button class="btn btn-secondary" id="btnVerPacientes" style="display:none;" onclick="verPacientes()">Ver Pacientes</button>
        <button class="btn btn-success" id="btnCrearCita" style="display:none;" onclick="crearCitaForm()">Crear Cita</button>

        <hr>

        <!-- Formulario de crear cita -->
        <div id="crearCitaForm" style="display:none;">
            <h2>Crear Cita</h2>
            <form id="formCrearCita">
                <label for="paciente">Paciente:</label>
                <select id="pacienteSelect" class="form-control" required></select><br>
                
                <label for="fechaHora">Fecha y Hora (de lunes a viernes, 17:00-20:00):</label>
                <input type="datetime-local" id="fechaHora" class="form-control" required><br>

                <button type="submit" class="btn btn-success">Guardar Cita</button>
            </form>
        </div>

        <!-- Lista de citas -->
        <div id="citasLista" style="display:none;">
            <h2>Citas</h2>
            <ul id="citasUl"></ul>
        </div>

        <!-- Lista de pacientes -->
        <div id="pacientesLista" style="display:none;">
            <h2>Pacientes</h2>
            <ul id="pacientesUl"></ul>
        </div>
    </div>

    <script>
        const citaUrl = '/citas';
        const pacienteUrl = '/pacientes';

        // Función para ver citas
        function verCitas() {
            fetch(citaUrl)
                .then(response => response.json())
                .then(citas => {
                    document.getElementById('citasLista').style.display = 'block';
                    document.getElementById('pacientesLista').style.display = 'none';
                    document.getElementById('crearCitaForm').style.display = 'none';
                    const citasUl = document.getElementById('citasUl');
                    citasUl.innerHTML = '';
                    citas.forEach(cita => {
                        const li = document.createElement('li');
                        li.textContent = `Cita con paciente ${cita.paciente.nombre} el ${cita.fechaHora}`;
                        citasUl.appendChild(li);
                    });
                });
        }

        // Función para ver pacientes
        function verPacientes() {
            fetch(pacienteUrl)
                .then(response => response.json())
                .then(pacientes => {
                    document.getElementById('pacientesLista').style.display = 'block';
                    document.getElementById('citasLista').style.display = 'none';
                    document.getElementById('crearCitaForm').style.display = 'none';
                    const pacientesUl = document.getElementById('pacientesUl');
                    pacientesUl.innerHTML = '';
                    pacientes.forEach(paciente => {
                        const li = document.createElement('li');
                        li.textContent = `${paciente.nombre} ${paciente.apellido}`;
                        pacientesUl.appendChild(li);
                    });
                });
        }

        // Función para crear la cita
        function crearCitaForm() {
            document.getElementById('pacienteSelect').innerHTML = '';
            fetch(pacienteUrl)
                .then(response => response.json())
                .then(pacientes => {
                    pacientes.forEach(paciente => {
                        const option = document.createElement('option');
                        option.value = paciente.id;
                        option.textContent = `${paciente.nombre} ${paciente.apellido}`;
                        document.getElementById('pacienteSelect').appendChild(option);
                    });
                });

            document.getElementById('crearCitaForm').style.display = 'block';
            document.getElementById('citasLista').style.display = 'none';
            document.getElementById('pacientesLista').style.display = 'none';
        }

        // Manejo del formulario de creación de cita
        document.getElementById('formCrearCita').addEventListener('submit', function(event) {
            event.preventDefault();

            const pacienteId = document.getElementById('pacienteSelect').value;
            const fechaHora = document.getElementById('fechaHora').value;

            const cita = {
                fechaHora: fechaHora,
            };

            fetch(`/citas/${pacienteId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cita)
            })
            .then(response => {
                if (!response.ok) {
                    // Si la respuesta no es ok, leer el mensaje de error
                    return response.text().then(text => {
                        throw new Error(text);  // Lanzar el error con el mensaje del backend
                    });
                }
                return response.json();  // Si la respuesta es ok, leer como JSON
            })
            .then(data => {
                alert('Cita creada con éxito');
                verCitas();  // Refrescar lista de citas
            })
            .catch(error => {
                alert('Error al crear la cita: ' + error.message);  // Mostrar el mensaje de error
            });
        });

        // Función para controlar la visibilidad de los botones según el usuario
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/usuario/estado')  // Suponiendo que tienes una API que devuelve el estado del usuario
                .then(response => response.json())
                .then(data => {
                    if (data.canCreateCita) {
                        document.getElementById('btnCrearCita').style.display = 'inline-block';
                    }
                    if (data.canViewCitas) {
                        document.getElementById('btnVerCitas').style.display = 'inline-block';
                    }
                    if (data.canViewPacientes) {
                        document.getElementById('btnVerPacientes').style.display = 'inline-block';
                    }
                })
                .catch(error => {
                    console.error('Error al obtener el estado del usuario:', error);
                });
        });
    </script>
    <a href="/logout">Cerrar sesión</a>
</body>
</html>
